<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeepFlow Pro - Flow Edition</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 顶级审美基础设置 --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(15, 15, 20, 0.7);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --accent-primary: #818cf8;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #020617; /* Deep Slate */
            color: #f8fafc;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 动态网格背景 --- */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 10% 20%, rgba(49, 46, 129, 0.15), transparent 40%), 
                radial-gradient(circle at 90% 80%, rgba(15, 23, 42, 0.3), transparent 40%);
            z-index: -1;
        }

        /* --- 高级玻璃拟态 --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 0 var(--glass-highlight);
        }

        .glass-modal {
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- 动画关键帧 --- */
        @keyframes breathe-glow {
            0%, 100% { transform: scale(1); opacity: 0.3; box-shadow: 0 0 30px rgba(99, 102, 241, 0.2); }
            50% { transform: scale(1.1); opacity: 0.6; box-shadow: 0 0 60px rgba(99, 102, 241, 0.5); }
        }
        
        @keyframes float-gentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2); }
        }

        @keyframes pulse-panic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* --- 实用类 --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .breathing-circle { animation: breathe-glow 8s infinite ease-in-out; }
        .urgent-glow { animation: pulse-red 2s infinite; border-color: rgba(239, 68, 68, 0.5) !important; }
        .panic-active { animation: pulse-panic 2s infinite; z-index: 50; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from { transform: translateY(100%); }
        .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body class="text-slate-200">

<div id="app" class="h-screen w-full flex flex-col relative overflow-hidden">

    <div class="ambient-bg"></div>

    <header class="px-6 py-4 pt-8 flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3" @click="toggleCalendarMode">
            <h1 class="text-xl font-bold tracking-tight">{{ currentMonthName }}</h1>
            <i :class="isCalendarExpanded ? 'rotate-180' : ''" data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform duration-300"></i>
        </div>
        
        <div class="flex items-center gap-2 glass-panel rounded-full px-3 py-1.5">
            <i data-lucide="zap" class="w-3 h-3" :class="energyLevel < 30 ? 'text-red-400' : 'text-yellow-400'"></i>
            <input type="range" v-model="energyLevel" min="0" max="100" class="w-16 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
        </div>
    </header>

    <section class="px-4 pb-2 z-20 transition-all duration-300 ease-in-out" :class="isCalendarExpanded ? 'h-auto' : 'h-16'">
        <div class="grid grid-cols-7 text-center mb-2">
            <span v-for="d in ['S','M','T','W','T','F','S']" class="text-[10px] text-slate-500 font-medium">{{d}}</span>
        </div>
        
        <div class="grid grid-cols-7 gap-y-2 text-center transition-all">
            <template v-for="(day, index) in visibleCalendarDays" :key="index">
                <div @click="selectDate(day)" 
                     class="flex flex-col items-center justify-center h-10 w-8 mx-auto rounded-xl cursor-pointer transition relative"
                     :class="isSelectedDate(day) ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-slate-400 hover:bg-white/5'">
                    
                    <span class="text-xs font-medium">{{ day ? day.getDate() : '' }}</span>
                    
                    <div v-if="day && hasTaskOnDate(day)" class="flex gap-0.5 mt-1">
                        <div v-if="hasCompletedTask(day)" class="w-1 h-1 rounded-full bg-green-400 shadow-[0_0_5px_rgba(74,222,128,0.5)]"></div>
                        <div v-else class="w-1 h-1 rounded-full bg-slate-600"></div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <main class="flex-1 relative overflow-y-auto no-scrollbar px-4 pb-32 pt-4">
        
        <div class="mb-8 px-2">
            <p class="text-sm text-indigo-300 font-medium mb-1">{{ energyAdvice }}</p>
            <h2 class="text-3xl font-bold text-white">{{ filteredTasks.length > 0 ? '顺势而为' : '此刻平静' }}</h2>
        </div>

        <div class="flex flex-wrap content-start gap-4 min-h-[300px]">
            <transition-group name="fade">
                
                <div v-for="task in filteredTasks" :key="task.id" 
                     @click="openSoftStart(task)"
                     class="glass-panel rounded-3xl p-5 flex flex-col justify-between cursor-pointer transition-all hover:scale-[1.02] hover:bg-white/10 active:scale-95 relative overflow-hidden group w-full"
                     :class="[getTaskSizeClass(task), isUrgent(task) ? 'urgent-glow' : '']">
                    
                    <div class="flex justify-between items-start">
                        <div class="pr-4">
                            <span class="text-lg font-medium text-slate-100 leading-snug">{{ task.title }}</span>
                            </div>
                        <div v-if="task.category" class="px-2 py-0.5 rounded-full bg-white/5 text-[10px] text-slate-400 border border-white/5">
                            {{ task.category }}
                        </div>
                    </div>

                    <div class="mt-4 flex items-center justify-between">
                        <div class="flex items-center gap-1.5 text-xs text-slate-500">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            <span>{{ task.deadline ? formatDeadline(task.deadline) : '无期限' }}</span>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i data-lucide="play" class="w-4 h-4 text-indigo-400 fill-indigo-400"></i>
                        </div>
                    </div>
                </div>

                <div key="add-btn" @click="showAddTask = true" class="w-full h-20 rounded-3xl border border-dashed border-slate-800 flex items-center justify-center text-slate-600 hover:text-slate-400 hover:border-slate-600 cursor-pointer transition">
                    <span class="text-sm font-medium">+ 放下一个念头</span>
                </div>

            </transition-group>

            <div v-if="hiddenTaskCount > 0" class="w-full text-center py-4 opacity-50">
                <i data-lucide="cloud-fog" class="w-5 h-5 mx-auto mb-1"></i>
                <p class="text-xs">已为你隐藏 {{ hiddenTaskCount }} 个复杂任务，专心做这一个就好。</p>
            </div>
        </div>
    </main>

    <div class="absolute bottom-8 left-0 w-full flex justify-center items-end pointer-events-none z-30">
        <div class="glass-panel px-4 py-3 rounded-full flex items-center gap-6 pointer-events-auto shadow-2xl shadow-black/80">
            <button @click="currentView = 'history'" class="p-2 text-slate-500 hover:text-white transition">
                <i data-lucide="archive" class="w-6 h-6"></i>
            </button>

            <button @click="startPanicMode" 
                    class="relative -mt-8 w-20 h-20 rounded-full bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center shadow-lg shadow-indigo-500/40 transition-transform active:scale-90"
                    :class="shouldPanicPulse ? 'panic-active' : ''">
                <i data-lucide="life-buoy" class="w-10 h-10 text-white"></i>
            </button>

            <button @click="currentView = 'settings'" class="p-2 text-slate-500 hover:text-white transition">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div v-if="showSoftStart && selectedTask" class="absolute inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass-modal w-full max-w-sm p-6 rounded-3xl animate-[float_0.4s_ease-out]">
            <h3 class="text-xl font-bold mb-2 text-center">{{ selectedTask.title }}</h3>
            <p class="text-slate-400 text-center text-sm mb-8">面对这个任务，你现在的感觉是？</p>
            
            <div class="grid grid-cols-2 gap-4">
                <button @click="startFocusMode(selectedTask)" class="group relative flex flex-col items-center justify-center p-4 rounded-2xl bg-emerald-500/10 border border-emerald-500/30 hover:bg-emerald-500/20 transition">
                    <i data-lucide="timer" class="w-8 h-8 text-emerald-400 mb-2 group-hover:scale-110 transition"></i>
                    <span class="font-bold text-emerald-300">只做 2 分钟</span>
                    <span class="text-[10px] text-emerald-500/70 mt-1">无需做完</span>
                </button>
                
                <button @click="triggerAiBreakdown(selectedTask)" class="group relative flex flex-col items-center justify-center p-4 rounded-2xl bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 transition">
                    <i data-lucide="layers" class="w-8 h-8 text-indigo-400 mb-2 group-hover:scale-110 transition"></i>
                    <span class="font-bold text-indigo-300">太难了</span>
                    <span class="text-[10px] text-indigo-500/70 mt-1">帮我切碎它</span>
                </button>
            </div>
            
            <button @click="showSoftStart = false" class="w-full mt-6 py-3 text-slate-500 text-sm">先不做了</button>
        </div>
    </div>

    <transition name="slide-up">
        <div v-if="isFocusMode" class="fixed inset-0 z-[60] bg-[#020617] flex flex-col items-center justify-center">
            <button @click="exitFocusMode" class="absolute top-8 right-8 text-slate-600 hover:text-white">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>

            <div class="relative w-72 h-72 flex items-center justify-center mb-16">
                <div class="absolute w-full h-full rounded-full bg-indigo-500/10 blur-3xl breathing-circle"></div>
                <div class="absolute w-48 h-48 rounded-full bg-indigo-400/20 blur-2xl breathing-circle" style="animation-delay: -2s"></div>
                
                <div class="relative z-10 text-center">
                    <div class="text-7xl font-light font-mono tracking-wider text-slate-100">{{ focusTimeDisplay }}</div>
                    <div class="text-sm text-slate-500 mt-4 tracking-widest uppercase">Flow State</div>
                </div>
            </div>

            <div class="text-center px-8 mb-12">
                <h3 class="text-xl font-medium text-slate-300 mb-2">{{ activeFocusTask?.title }}</h3>
                <p class="text-slate-500 text-sm">如果你想停下来，随时都可以。</p>
            </div>

            <button @click="completeTaskInFocus" class="px-12 py-4 rounded-full bg-white text-black font-bold text-lg hover:scale-105 transition shadow-[0_0_40px_rgba(255,255,255,0.3)]">
                我做完了
            </button>
        </div>
    </transition>

    <transition name="slide-up">
        <div v-if="currentView === 'panic'" class="fixed inset-0 z-[55] bg-slate-900 flex flex-col">
            <div class="p-4 flex justify-between items-center bg-slate-800/50">
                <span class="font-bold text-indigo-300">AI 辅助</span>
                <button @click="currentView = 'dashboard'" class="p-2 bg-slate-700 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div v-for="(msg, i) in chatHistory" :key="i" class="flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                    <div class="max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed" 
                         :class="msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-200'">
                        {{ msg.content }}
                        <div v-if="msg.steps" class="mt-4 space-y-2">
                             <div v-for="(step, sIdx) in msg.steps" :key="sIdx" class="flex items-center gap-3 p-2 rounded bg-slate-700/50" @click="toggleSubStep(i, sIdx)">
                                 <div class="w-5 h-5 rounded-full border border-slate-500 flex items-center justify-center transition" :class="step.done ? 'bg-green-500 border-green-500' : ''">
                                     <i v-if="step.done" data-lucide="check" class="w-3 h-3 text-white"></i>
                                 </div>
                                 <span :class="step.done ? 'line-through text-slate-500' : ''">{{ step.text }}</span>
                             </div>
                        </div>
                    </div>
                </div>
                <div v-if="isAiLoading" class="text-slate-500 text-xs ml-4">AI 正在温柔地思考...</div>
            </div>

            <div class="p-4 bg-slate-800/80 backdrop-blur">
                <div class="relative">
                    <input v-model="chatInput" @keydown.enter="sendChat" placeholder="说点什么..." class="w-full bg-slate-700 p-4 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button @click="sendChat" class="absolute right-2 top-2 p-2 bg-indigo-600 rounded-lg"><i data-lucide="send" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </transition>

    <div v-if="showAddTask" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="glass-modal w-full max-w-sm p-6 rounded-3xl">
            <h3 class="text-lg font-bold mb-4">新的念头</h3>
            <input v-model="newTaskTitle" placeholder="我想..." class="w-full bg-slate-800 p-4 rounded-xl mb-4 text-white outline-none">
            <div class="mb-4">
                <label class="text-xs text-slate-500 mb-2 block">截止时间 (可选)</label>
                <input type="datetime-local" v-model="newTaskDeadline" class="w-full bg-slate-800 p-3 rounded-xl text-white text-sm">
            </div>
            <div class="flex gap-2">
                <button @click="showAddTask = false" class="flex-1 py-3 text-slate-400">取消</button>
                <button @click="addTask" class="flex-1 py-3 bg-indigo-600 rounded-xl font-bold">放下</button>
            </div>
        </div>
    </div>

    <div v-if="currentView === 'settings'" class="fixed inset-0 z-50 bg-slate-900 flex flex-col p-6">
        <h2 class="text-2xl font-bold mb-6">设置</h2>
        <label class="text-sm text-slate-400 mb-2">Google Gemini API Key</label>
        <input v-model="apiKey" type="password" class="w-full bg-slate-800 p-4 rounded-xl mb-4 text-white">
        <button @click="saveSettings" class="w-full py-4 bg-indigo-600 rounded-xl font-bold mb-4">保存</button>
        <button @click="currentView = 'dashboard'" class="text-slate-500">返回</button>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- 核心数据 ---
            const currentView = ref('dashboard');
            const apiKey = ref(localStorage.getItem('df_key') || '');
            const tasks = ref(JSON.parse(localStorage.getItem('df_tasks') || '[]'));
            const energyLevel = ref(60); // 默认 60%
            const lastActiveTime = ref(parseInt(localStorage.getItem('df_last_active') || Date.now()));
            
            // --- 日历状态 ---
            const today = new Date();
            const selectedDate = ref(today); // 默认选中今天
            const calendarViewDate = ref(today);
            const isCalendarExpanded = ref(false);

            // --- UI 交互状态 ---
            const showAddTask = ref(false);
            const newTaskTitle = ref('');
            const newTaskDeadline = ref('');
            const showSoftStart = ref(false);
            const selectedTask = ref(null);
            
            // --- 专注模式状态 ---
            const isFocusMode = ref(false);
            const activeFocusTask = ref(null);
            const focusStartTime = ref(0);
            const focusTimeDisplay = ref("00:00");
            let focusTimerInterval = null;

            // --- AI 聊天状态 ---
            const chatHistory = ref([]);
            const chatInput = ref('');
            const isAiLoading = ref(false);

            // ================== 计算属性 ==================

            // 1. 日历生成逻辑
            const currentMonthName = computed(() => {
                return calendarViewDate.value.toLocaleString('zh-CN', { month: 'long', year: 'numeric' });
            });

            const visibleCalendarDays = computed(() => {
                const year = calendarViewDate.value.getFullYear();
                const month = calendarViewDate.value.getMonth();
                const days = [];
                
                if (!isCalendarExpanded.value) {
                    // 折叠模式：只显示当前选中日期所在的那一周
                    const current = new Date(selectedDate.value);
                    const dayOfWeek = current.getDay(); // 0 (Sun) - 6 (Sat)
                    const startOfWeek = new Date(current);
                    startOfWeek.setDate(current.getDate() - dayOfWeek);
                    
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(startOfWeek);
                        d.setDate(startOfWeek.getDate() + i);
                        days.push(d);
                    }
                    return days;
                } else {
                    // 展开模式：显示当月所有日期 (简单的 7x5 网格逻辑)
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    // 补前面的空位
                    for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                    // 填日期
                    for (let i = 1; i <= lastDay.getDate(); i++) {
                        days.push(new Date(year, month, i));
                    }
                    return days;
                }
            });

            // 2. 核心过滤器：日期 + 能量
            const hiddenTaskCount = ref(0);
            
            const filteredTasks = computed(() => {
                // Step 1: 按日期过滤
                let list = tasks.value.filter(t => !t.completed);
                
                // 只有当选中的是“今天”时，才应用能量过滤。如果是查看过去/未来，显示全部。
                const isViewingToday = isSameDay(selectedDate.value, new Date());
                
                if (!isViewingToday) {
                    // 如果查看特定日期，只显示该日期创建的 或 该日期截止的
                    list = list.filter(t => isSameDay(new Date(t.createdAt), selectedDate.value) || (t.deadline && isSameDay(new Date(t.deadline), selectedDate.value)));
                    hiddenTaskCount.value = 0;
                    return list;
                }

                // Step 2: 能量过滤 (Energy Filter)
                hiddenTaskCount.value = 0;
                
                // 排序：有DDL且临近的优先，否则按创建时间
                list.sort((a, b) => {
                    const timeA = a.deadline ? new Date(a.deadline).getTime() : Infinity;
                    const timeB = b.deadline ? new Date(b.deadline).getTime() : Infinity;
                    return timeA - timeB;
                });

                if (energyLevel.value < 30) {
                    // 极低能量：只显示最简单的 1 个 (假设字数少=简单，或者没有DDL)
                    hiddenTaskCount.value = Math.max(0, list.length - 1);
                    return list.slice(0, 1);
                } else if (energyLevel.value < 60) {
                    // 低能量：显示前 3 个
                    hiddenTaskCount.value = Math.max(0, list.length - 3);
                    return list.slice(0, 3);
                }
                
                return list;
            });

            // 3. 能量建议文案
            const energyAdvice = computed(() => {
                if (energyLevel.value < 30) return "别勉强，只做这一件小事就好。";
                if (energyLevel.value < 60) return "保留精力，先处理重要的。";
                return "状态不错，保持心流。";
            });

            // 4. Panic 按钮呼吸逻辑
            const shouldPanicPulse = computed(() => {
                const now = Date.now();
                const hoursInactive = (now - lastActiveTime.value) / (1000 * 60 * 60);
                const hasOverdue = tasks.value.some(t => !t.completed && t.deadline && new Date(t.deadline) < now);
                return hoursInactive > 24 || hasOverdue;
            });

            // ================== 方法 ==================

            // --- 日历相关 ---
            const toggleCalendarMode = () => isCalendarExpanded.value = !isCalendarExpanded.value;
            
            const selectDate = (date) => {
                if(date) selectedDate.value = date;
            };
            
            const isSameDay = (d1, d2) => {
                return d1.getFullYear() === d2.getFullYear() &&
                       d1.getMonth() === d2.getMonth() &&
                       d1.getDate() === d2.getDate();
            };

            const isSelectedDate = (date) => date && isSameDay(date, selectedDate.value);
            
            const hasTaskOnDate = (date) => {
                if (!date) return false;
                return tasks.value.some(t => isSameDay(new Date(t.createdAt), date) || (t.deadline && isSameDay(new Date(t.deadline), date)));
            };

            const hasCompletedTask = (date) => {
                if (!date) return false;
                return tasks.value.some(t => t.completed && isSameDay(new Date(t.completedAt), date));
            };

            // --- 任务管理 ---
            const addTask = () => {
                if (!newTaskTitle.value) return;
                tasks.value.push({
                    id: Date.now(),
                    title: newTaskTitle.value,
                    deadline: newTaskDeadline.value || null,
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showAddTask.value = false;
                newTaskTitle.value = '';
                newTaskDeadline.value = '';
                saveData();
            };

            const isUrgent = (task) => {
                if (!task.deadline) return false;
                const diff = new Date(task.deadline) - new Date();
                return diff > 0 && diff < 24 * 60 * 60 * 1000; // 24小时内
            };

            const getTaskSizeClass = (task) => {
                // 简单的视觉逻辑：任务越重要(有DDL)或字数少(简洁)，卡片可能越大
                return task.deadline ? 'col-span-2' : 'col-span-1';
            };

            const formatDeadline = (iso) => {
                const d = new Date(iso);
                return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()<10?'0':''}${d.getMinutes()}`;
            };

            // --- 软启动 & 专注模式 ---
            const openSoftStart = (task) => {
                selectedTask.value = task;
                showSoftStart.value = true;
            };

            const startFocusMode = (task) => {
                showSoftStart.value = false;
                activeFocusTask.value = task;
                isFocusMode.value = true;
                focusStartTime.value = Date.now();
                
                // 启动正计时
                focusTimerInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - focusStartTime.value) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    focusTimeDisplay.value = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                }, 1000);
            };

            const exitFocusMode = () => {
                isFocusMode.value = false;
                clearInterval(focusTimerInterval);
                focusTimeDisplay.value = "00:00";
            };

            const completeTaskInFocus = () => {
                // 撒花
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                // 标记完成
                const t = tasks.value.find(x => x.id === activeFocusTask.value.id);
                if (t) {
                    t.completed = true;
                    t.completedAt = new Date().toISOString();
                }
                saveData();
                
                setTimeout(() => exitFocusMode(), 1500);
            };

            // --- Panic Mode & AI ---
            const startPanicMode = () => {
                currentView.value = 'panic';
                if (chatHistory.value.length === 0) {
                    chatHistory.value.push({ 
                        role: 'assistant', 
                        content: '我是这里的 AI 咨询师。我知道你可能觉得有点累，或者不知所措。这完全正常。\n\n我们只需要做一件事：把手机放在一边，深呼吸一次。告诉我，什么事情让你觉得最难开始？' 
                    });
                }
            };

            const triggerAiBreakdown = (task) => {
                showSoftStart.value = false;
                startPanicMode();
                chatInput.value = `帮我拆解任务：${task.title}。我觉得很难开始。`;
                sendChat();
            };

            const sendChat = async () => {
                if (!chatInput.value.trim() || !apiKey.value) return;
                
                const userMsg = chatInput.value;
                chatHistory.value.push({ role: 'user', content: userMsg });
                chatInput.value = '';
                isAiLoading.value = true;

                // 心理咨询师 Prompt
                const systemPrompt = `你是一位富有同情心的 CBT (认知行为疗法) 治疗师。用户患有执行功能障碍。
                
                原则：
                1. 永远不要说教。
                2. 将任务拆解为极小的、物理上的步骤 (例如："走到桌子旁", "打开电脑盖", "输入标题")。
                3. 第一步必须简单到荒谬，不需要意志力。
                
                如果用户请求拆解任务，请在回复的最后，附带一个纯 JSON 数组，格式为：[{"text": "第一步...", "done": false}, {"text": "第二步...", "done": false}]。
                不要用 Markdown 代码块包裹 JSON，直接放在文本最后即可。`;

                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey.value}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ 
                                role: "user", 
                                parts: [{ text: systemPrompt + "\n\nUser: " + userMsg }] 
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    let replyText = data.candidates[0].content.parts[0].text;
                    
                    // 解析 JSON 步骤
                    let steps = null;
                    const jsonMatch = replyText.match(/\[\s*\{.*\}\s*\]/s);
                    if (jsonMatch) {
                        try {
                            steps = JSON.parse(jsonMatch[0]);
                            replyText = replyText.replace(jsonMatch[0], '').trim();
                        } catch (e) { console.error("JSON parse fail", e); }
                    }

                    chatHistory.value.push({ role: 'assistant', content: replyText, steps: steps });
                    nextTick(() => document.getElementById('chat-box').scrollTop = 9999);

                } catch (e) {
                    chatHistory.value.push({ role: 'assistant', content: "抱歉，我现在连接宇宙有点困难。请检查网络或 API Key。" });
                } finally {
                    isAiLoading.value = false;
                }
            };

            const toggleSubStep = (msgIndex, stepIndex) => {
                chatHistory.value[msgIndex].steps[stepIndex].done = !chatHistory.value[msgIndex].steps[stepIndex].done;
                if (chatHistory.value[msgIndex].steps[stepIndex].done) {
                    confetti({ particleCount: 30, spread: 50, origin: { y: 0.8 }, shapes: ['circle'] });
                }
            };

            // --- 持久化 ---
            const saveSettings = () => {
                localStorage.setItem('df_key', apiKey.value);
                currentView.value = 'dashboard';
            };
            
            const saveData = () => {
                localStorage.setItem('df_tasks', JSON.stringify(tasks.value));
                lastActiveTime.value = Date.now();
                localStorage.setItem('df_last_active', lastActiveTime.value);
            };
            
            watch(tasks, saveData, { deep: true });

            onMounted(() => {
                lucide.createIcons();
                if(!apiKey.value) currentView.value = 'settings';
                saveData(); // 更新活跃时间
            });

            watch([currentView, showSoftStart, isFocusMode, filteredTasks], () => {
                setTimeout(() => lucide.createIcons(), 100);
            });

            return {
                currentView, apiKey, energyLevel, energyAdvice,
                isCalendarExpanded, currentMonthName, visibleCalendarDays, toggleCalendarMode, selectDate, isSelectedDate, hasTaskOnDate, hasCompletedTask,
                filteredTasks, hiddenTaskCount, showAddTask, newTaskTitle, newTaskDeadline, addTask, isUrgent, getTaskSizeClass, formatDeadline,
                showSoftStart, selectedTask, openSoftStart, startFocusMode, triggerAiBreakdown,
                isFocusMode, activeFocusTask, focusTimeDisplay, exitFocusMode, completeTaskInFocus,
                shouldPanicPulse, startPanicMode,
                chatHistory, chatInput, isAiLoading, sendChat, toggleSubStep, saveSettings
            };
        }
    }).mount('#app');
</script>
</body>
</html>
