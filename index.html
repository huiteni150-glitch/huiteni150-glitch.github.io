<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeepFlow Pro</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- é¡¶çº§å®¡ç¾åŸºç¡€è®¾ç½® --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 25, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --accent-primary: #6366f1; /* Indigo */
            --accent-glow: rgba(99, 102, 241, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #050505;
            color: #f8fafc;
            overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ï¼Œå†…éƒ¨æ»šåŠ¨ */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ (Mesh Gradient) --- */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(56, 189, 248, 0.1), transparent 25%);
            z-index: -1;
            filter: blur(60px);
        }

        /* --- é«˜çº§ç»ç’ƒæ‹Ÿæ€ --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 0 var(--glass-highlight);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* --- æµä½“æ°”æ³¡åŠ¨ç”» (Liquid Bubble) --- */
        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(0, 8px); }
            100% { transform: translate(0, 0); }
        }
        .bubble-float {
            animation: float 6s ease-in-out infinite;
        }
        .bubble-delay-1 { animation-delay: 1s; }
        .bubble-delay-2 { animation-delay: 2s; }
        .bubble-delay-3 { animation-delay: 3s; }

        /* --- å‘¼å¸ç¯æŒ‰é’® --- */
        .panic-btn {
            background: radial-gradient(circle at center, #4f46e5 0%, #312e81 100%);
            box-shadow: 0 0 30px var(--accent-glow);
            animation: panic-breathe 4s infinite ease-in-out;
        }
        @keyframes panic-breathe {
            0% { transform: scale(1); box-shadow: 0 0 30px rgba(79, 70, 229, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 60px rgba(79, 70, 229, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 30px rgba(79, 70, 229, 0.4); }
        }

        /* --- é¡µé¢åˆ‡æ¢è¿‡æ¸¡ --- */
        .page-enter-active, .page-leave-active {
            transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .page-enter-from { opacity: 0; transform: scale(0.98) translateY(10px); }
        .page-leave-to { opacity: 0; transform: scale(1.02); }

        /* --- æ»šåŠ¨æ¡éšè— --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500 selection:text-white">

<div id="app" class="h-screen w-full flex flex-col relative">

    <div class="ambient-bg"></div>

    <div class="px-6 py-4 flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xs font-bold shadow-lg shadow-indigo-500/20">
                DF
            </div>
            <span class="text-sm font-medium tracking-wide text-slate-300">{{ getCurrentGreeting() }}</span>
        </div>
        <div class="flex items-center gap-2">
            <div @click="view = 'energy'" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full glass-panel cursor-pointer hover:bg-white/5 transition">
                <i data-lucide="zap" class="w-3 h-3 text-yellow-400" :class="{'fill-yellow-400': energyLevel > 50}"></i>
                <span class="text-xs font-mono text-slate-300">{{ energyLevel }}%</span>
            </div>
            <button @click="view = 'settings'" class="p-2 rounded-full hover:bg-white/10 transition text-slate-400 hover:text-white">
                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <main class="flex-1 relative overflow-hidden z-10">
        <transition name="page" mode="out-in">
            
            <div v-if="view === 'dashboard'" key="dashboard" class="h-full w-full p-6 overflow-y-auto no-scrollbar pb-32">
                
                <div class="mb-10 text-center relative">
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-b from-white to-white/60 mb-2 tracking-tight">
                        {{ focusTask ? 'å½“ä¸‹' : 'è‡ªç”±æµåŠ¨' }}
                    </h1>
                    <p v-if="focusTask" class="text-indigo-300 text-lg animate-pulse">{{ focusTask.title }}</p>
                    <p v-else class="text-slate-500 text-sm">åƒæ°´ä¸€æ ·ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚</p>
                </div>

                <div class="relative min-h-[400px] w-full flex flex-wrap content-center justify-center gap-6">
                    
                    <div v-if="activeTasks.length === 0" class="text-center opacity-40 mt-12">
                        <i data-lucide="wind" class="w-12 h-12 mx-auto mb-4 text-slate-500"></i>
                        <p>æ²¡æœ‰æ¶Ÿæ¼ªã€‚</p>
                        <button @click="openAddTask" class="mt-4 text-indigo-400 text-sm hover:text-indigo-300">æ·»åŠ ä¸€ä¸ªå¿µå¤´</button>
                    </div>

                    <div v-for="(task, index) in activeTasks" :key="task.id" 
                         @click="activateTask(task)"
                         class="glass-panel rounded-full flex items-center justify-center text-center p-6 cursor-pointer transition-all duration-500 hover:scale-110 hover:border-indigo-500/50 hover:shadow-[0_0_30px_rgba(99,102,241,0.2)] bubble-float group"
                         :class="['bubble-delay-' + (index % 3 + 1)]"
                         :style="getBubbleStyle(task)">
                        <div>
                            <span class="block text-sm font-medium text-slate-200 group-hover:text-white">{{ task.title }}</span>
                            <span class="block text-[10px] text-slate-500 mt-1 uppercase tracking-wider" v-if="task.deadline">DDL: {{ formatTime(task.deadline) }}</span>
                        </div>
                    </div>

                    <div @click="openAddTask" class="w-16 h-16 rounded-full border border-dashed border-slate-700 flex items-center justify-center text-slate-600 hover:text-white hover:border-slate-500 hover:bg-white/5 cursor-pointer transition bubble-float bubble-delay-2">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>

                </div>
            </div>

            <div v-if="view === 'panic'" key="panic" class="h-full w-full flex flex-col p-6 max-w-xl mx-auto">
                
                <div id="chat-container" class="flex-1 overflow-y-auto no-scrollbar mb-6 space-y-4 pt-4">
                    <div v-for="(msg, i) in chatHistory" :key="i" 
                         class="flex w-full" 
                         :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg"
                             :class="msg.role === 'user' 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : 'glass-panel text-slate-200 rounded-bl-none border-l-2 border-indigo-400'">
                            <p class="whitespace-pre-wrap">{{ msg.content }}</p>
                            <div v-if="msg.actions && !msg.actionTaken" class="mt-4 flex flex-wrap gap-2">
                                <button v-for="action in msg.actions" @click="handleAction(action, i)" 
                                        class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-xs border border-white/5 transition">
                                    {{ action.label }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-if="isAiTyping" class="flex items-center gap-2 text-slate-500 text-xs ml-2">
                        <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                        AI æ­£åœ¨æ¸©æŸ”åœ°æ€è€ƒ...
                    </div>
                </div>

                <div class="shrink-0 mb-20">
                    <div v-if="panicMode === 'steps'" class="glass-panel p-6 rounded-3xl text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 h-1 bg-green-500 transition-all duration-700" :style="{width: stepProgress + '%'}"></div>
                        <p class="text-xs text-slate-400 uppercase tracking-widest mb-4">å½“å‰å¾®ä»»åŠ¡</p>
                        <h2 class="text-2xl font-bold text-white mb-8">{{ currentSteps[currentStepIndex] }}</h2>
                        
                        <button @click="completeStep" class="w-full py-4 rounded-2xl bg-green-600 hover:bg-green-500 text-white font-bold text-lg shadow-lg shadow-green-900/30 transition active:scale-95">
                            æˆ‘åšåˆ°äº†
                        </button>
                        <div class="mt-4 flex justify-between text-xs text-slate-500">
                             <button @click="negotiateStep">è¿™æ­¥å¤ªéš¾äº†...</button>
                             <span>{{ currentStepIndex + 1 }} / {{ currentSteps.length }}</span>
                        </div>
                    </div>

                    <div v-else class="relative">
                        <textarea v-model="userInput" @keydown.enter.prevent="sendMessage" placeholder="å‘Šè¯‰æˆ‘ï¼Œä»€ä¹ˆè®©ä½ å¡ä½äº†..." class="glass-input w-full p-4 pr-12 rounded-2xl h-14 resize-none"></textarea>
                        <button @click="sendMessage" :disabled="!userInput.trim()" class="absolute right-2 top-2 p-2.5 bg-indigo-600 rounded-xl text-white disabled:opacity-50 disabled:bg-transparent">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="view === 'energy'" key="energy" class="h-full w-full flex flex-col justify-center items-center p-8 max-w-md mx-auto text-center">
                <i data-lucide="battery-charging" class="w-16 h-16 text-indigo-400 mb-6"></i>
                <h2 class="text-3xl font-bold mb-2">èƒ½é‡æ ¡å‡†</h2>
                <p class="text-slate-400 mb-10 text-sm">è¯šå®åœ°å‘Šè¯‰ AI ä½ çš„çŠ¶æ€ã€‚ä¸éœ€è¦é€å¼ºã€‚</p>

                <div class="w-full mb-8">
                    <div class="flex justify-between mb-2 text-sm font-medium">
                        <span class="text-slate-500">ç²¾ç–²åŠ›å°½</span>
                        <span class="text-indigo-400">ç²¾åŠ›å……æ²›</span>
                    </div>
                    <input type="range" v-model="energyLevel" min="0" max="100" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                    <div class="mt-2 text-2xl font-mono">{{ energyLevel }}%</div>
                </div>

                <div class="w-full mb-12">
                    <div class="flex justify-between mb-2 text-sm font-medium">
                        <span class="text-slate-500">ç„¦è™‘/ä½è½</span>
                        <span class="text-pink-400">å¹³é™/æ„‰æ‚¦</span>
                    </div>
                    <input type="range" v-model="moodLevel" min="0" max="100" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-pink-500">
                    <div class="mt-2 text-xl">{{ getMoodEmoji(moodLevel) }}</div>
                </div>

                <button @click="analyzeEnergy" class="w-full py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> ç”Ÿæˆä»Šæ—¥å»ºè®®
                </button>
            </div>

            <div v-if="view === 'history'" key="history" class="h-full w-full p-6 overflow-y-auto no-scrollbar pb-32">
                <h2 class="text-2xl font-bold mb-6 px-2">æ—¶å…‰èƒ¶å›Š</h2>
                
                <div v-if="archivedTasks.length === 0" class="text-center text-slate-500 mt-20">
                    <p>è¿™é‡Œè¿˜æ˜¯ä¸€ç‰‡ç©ºç™½ã€‚</p>
                </div>

                <div class="space-y-3">
                    <div v-for="task in archivedTasks" :key="task.id" class="glass-panel p-4 rounded-xl flex items-center justify-between opacity-70 hover:opacity-100 transition">
                        <div>
                            <div class="font-medium text-slate-300 line-through decoration-slate-500">{{ task.title }}</div>
                            <div class="text-xs text-slate-600">{{ new Date(task.completedAt).toLocaleDateString() }} Â· {{ task.category || 'æœªåˆ†ç±»' }}</div>
                        </div>
                        <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center">
                            <i data-lucide="check" class="w-3 h-3 text-green-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="view === 'settings'" key="settings" class="h-full w-full p-6 pt-12 overflow-y-auto max-w-md mx-auto">
                <h2 class="text-3xl font-bold mb-8">è®¾ç½®</h2>

                <div class="glass-panel p-6 rounded-2xl mb-6">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">æ ¸å¿ƒé©±åŠ¨ (AI)</h3>
                    
                    <label class="block text-xs text-slate-500 mb-2">Google Gemini API Key</label>
                    <input type="password" v-model="tempKey" placeholder="ç²˜è´´ Key..." class="glass-input w-full p-3 rounded-lg mb-4 text-sm">
                    
                    <label class="block text-xs text-slate-500 mb-2">é€‰æ‹©æ¨¡å‹</label>
                    <select v-model="selectedModel" class="glass-input w-full p-3 rounded-lg mb-4 text-sm bg-black">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Stable)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                        <option value="custom">è‡ªå®šä¹‰è¾“å…¥...</option>
                    </select>

                    <input v-if="selectedModel === 'custom'" v-model="customModelName" type="text" placeholder="è¾“å…¥æ¨¡å‹åç§° (å¦‚ gemini-1.0-pro)" class="glass-input w-full p-3 rounded-lg mb-4 text-sm">

                    <button @click="saveSettings" class="w-full py-3 bg-indigo-600 rounded-xl text-white font-bold text-sm">ä¿å­˜é…ç½®</button>
                    <p class="text-[10px] text-slate-600 mt-2 text-center">Keys ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå®‰å…¨æ— å¿§ã€‚</p>
                </div>
            </div>

        </transition>

        <div v-if="showAddTask" class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-sm p-6 rounded-3xl animate-[float_0.5s_ease-out]">
                <h3 class="text-xl font-bold mb-4">æ–°çš„å¿µå¤´</h3>
                <input v-model="newTaskTitle" placeholder="æˆ‘æƒ³..." class="glass-input w-full p-4 rounded-xl mb-4 text-lg">
                <div class="flex gap-2 mb-6">
                    <button v-for="cat in ['å·¥ä½œ', 'ç”Ÿæ´»', 'è‡ªæˆ‘', 'çäº‹']" 
                            @click="newTaskCategory = cat"
                            :class="newTaskCategory === cat ? 'bg-indigo-600 text-white' : 'bg-white/5 text-slate-400'"
                            class="px-3 py-1.5 rounded-full text-xs transition">
                        {{ cat }}
                    </button>
                </div>
                <div class="flex gap-3">
                    <button @click="showAddTask = false" class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-slate-300">å–æ¶ˆ</button>
                    <button @click="addTask" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold">æ”¾ä¸‹</button>
                </div>
            </div>
        </div>

    </main>

    <div class="absolute bottom-6 left-0 w-full px-6 flex justify-center z-30 pointer-events-none">
        <nav class="glass-panel px-2 py-2 rounded-full flex gap-1 pointer-events-auto shadow-2xl shadow-black/50">
            <button @click="view = 'dashboard'" :class="view === 'dashboard' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'" class="p-3 rounded-full transition-all">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
            </button>
            
            <button @click="startPanicMode" class="mx-2 -mt-6 panic-btn w-16 h-16 rounded-full flex items-center justify-center text-white transition-transform active:scale-95">
                <i data-lucide="life-buoy" class="w-8 h-8"></i>
            </button>

            <button @click="view = 'history'" :class="view === 'history' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'" class="p-3 rounded-full transition-all">
                <i data-lucide="archive" class="w-6 h-6"></i>
            </button>
        </nav>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- æ ¸å¿ƒçŠ¶æ€ ---
            const view = ref('dashboard'); // dashboard, panic, energy, history, settings
            const apiKey = ref(localStorage.getItem('gemini_key') || '');
            const tempKey = ref('');
            const selectedModel = ref(localStorage.getItem('gemini_model') || 'gemini-1.5-pro');
            const customModelName = ref(localStorage.getItem('gemini_custom_model') || '');

            // --- ä»»åŠ¡æ•°æ® ---
            const tasks = ref(JSON.parse(localStorage.getItem('deepflow_tasks') || '[]'));
            const showAddTask = ref(false);
            const newTaskTitle = ref('');
            const newTaskCategory = ref('ç”Ÿæ´»');
            const focusTask = ref(null); // å½“å‰æ­£åœ¨èšç„¦çš„å•ä»»åŠ¡

            // --- èƒ½é‡ä¸å¿ƒæƒ… ---
            const energyLevel = ref(60);
            const moodLevel = ref(50);

            // --- èŠå¤©/Panic çŠ¶æ€ ---
            const panicMode = ref('chat'); // chat, steps
            const chatHistory = ref([]);
            const userInput = ref('');
            const isAiTyping = ref(false);
            const currentSteps = ref([]);
            const currentStepIndex = ref(0);

            // --- è®¡ç®—å±æ€§ ---
            const activeTasks = computed(() => tasks.value.filter(t => !t.completed));
            const archivedTasks = computed(() => tasks.value.filter(t => t.completed).reverse());
            const stepProgress = computed(() => {
                if (!currentSteps.value.length) return 0;
                return ((currentStepIndex.value) / currentSteps.value.length) * 100;
            });

            // --- ç”Ÿå‘½å‘¨æœŸ & ç›‘å¬ ---
            watch(tasks, (newVal) => {
                localStorage.setItem('deepflow_tasks', JSON.stringify(newVal));
            }, { deep: true });

            onMounted(() => {
                lucide.createIcons();
                // æ£€æŸ¥æ˜¯å¦ç¬¬ä¸€æ¬¡è¿›å…¥
                if (!apiKey.value) view.value = 'settings';
            });
            
            watch(view, () => setTimeout(() => lucide.createIcons(), 50));

            // --- åŠŸèƒ½æ–¹æ³• ---

            const getCurrentGreeting = () => {
                const hour = new Date().getHours();
                if (hour < 6) return 'æ·±å¤œå¥½ï¼Œè¦ä¼‘æ¯å—ï¼Ÿ';
                if (hour < 12) return 'æ—©å®‰ï¼Œä»Šå¤©æƒ³åšç‚¹ä»€ä¹ˆï¼Ÿ';
                if (hour < 18) return 'åˆåï¼Œä¿æŒèŠ‚å¥ã€‚';
                return 'æ™šä¸Šå¥½ï¼Œåˆ«ç»™è‡ªå·±å‹åŠ›ã€‚';
            };

            const getMoodEmoji = (val) => {
                if (val < 20) return 'â›ˆï¸';
                if (val < 40) return 'â˜ï¸';
                if (val < 60) return 'ğŸ˜';
                if (val < 80) return 'ğŸŒ¤ï¸';
                return 'â˜€ï¸';
            };

            const formatTime = (iso) => {
                const date = new Date(iso);
                return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()<10?'0':''}${date.getMinutes()}`;
            };

            // æ°”æ³¡æ ·å¼è®¡ç®— (æ¨¡æ‹Ÿé‡è¦æ€§å’Œéšæœºæµ®åŠ¨)
            const getBubbleStyle = (task) => {
                // ç®€å•ç®—æ³•ï¼šå­—æ•°è¶Šå°‘ï¼Œæˆ–è€…æœ‰DDLï¼Œæ³¡æ³¡è¶Šå¤§
                let size = 120;
                if (task.deadline) size += 20;
                if (task.title.length < 5) size += 10;
                
                // é¢œè‰²æ˜ å°„
                const colors = {
                    'å·¥ä½œ': 'rgba(56, 189, 248, 0.2)',
                    'ç”Ÿæ´»': 'rgba(167, 139, 250, 0.2)',
                    'è‡ªæˆ‘': 'rgba(251, 113, 133, 0.2)',
                    'çäº‹': 'rgba(148, 163, 184, 0.2)'
                };
                const bg = colors[task.category] || colors['çäº‹'];
                const border = bg.replace('0.2', '0.4');

                return {
                    width: `${size}px`,
                    height: `${size}px`,
                    background: bg,
                    borderColor: border
                };
            };

            // ä»»åŠ¡ç®¡ç†
            const openAddTask = () => showAddTask.value = true;
            const addTask = () => {
                if (!newTaskTitle.value) return;
                tasks.value.push({
                    id: Date.now(),
                    title: newTaskTitle.value,
                    category: newTaskCategory.value,
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                newTaskTitle.value = '';
                showAddTask.value = false;
            };

            const activateTask = (task) => {
                focusTask.value = task;
                // è¿™é‡Œå¯ä»¥å¼¹å‡ºå…·ä½“çš„ä»»åŠ¡è¯¦æƒ…ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥ Unstuck æ¨¡å¼
                if (confirm(`è¦å¼€å§‹åš "${task.title}" å—ï¼Ÿå¦‚æœè§‰å¾—éš¾ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾ AI èŠèŠã€‚`)) {
                     // å¯ä»¥åœ¨è¿™é‡Œé€‰æ‹©ç›´æ¥å¼€å§‹æˆ–è€…æ±‚åŠ©
                     startPanicMode(task.title);
                }
            };

            // è®¾ç½®ç®¡ç†
            const saveSettings = () => {
                localStorage.setItem('gemini_key', tempKey.value);
                localStorage.setItem('gemini_model', selectedModel.value);
                localStorage.setItem('gemini_custom_model', customModelName.value);
                apiKey.value = tempKey.value;
                view.value = 'dashboard';
                alert('é…ç½®å·²ä¿å­˜ã€‚AI å·²å°±ç»ªã€‚');
            };

            // --- æ ¸å¿ƒ AI é€»è¾‘ (Gemini API) ---

            const callGemini = async (prompt, systemInstruction = "") => {
                if (!apiKey.value) {
                    alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key");
                    view.value = 'settings';
                    return null;
                }

                isAiTyping.value = true;
                const modelName = selectedModel.value === 'custom' ? customModelName.value : selectedModel.value;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey.value}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ 
                                role: "user",
                                parts: [{ text: systemInstruction + "\n\nUser Input: " + prompt }] 
                            }]
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;

                } catch (e) {
                    console.error(e);
                    return "AI è¿æ¥ä¼¼ä¹æ–­å¼€äº†... (è¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œ)";
                } finally {
                    isAiTyping.value = false;
                }
            };

            // --- åœºæ™¯ 1: èƒ½é‡åˆ†æ ---
            const analyzeEnergy = async () => {
                const prompt = `Energy: ${energyLevel.value}%, Mood: ${moodLevel.value}%. Tasks: ${activeTasks.value.map(t=>t.title).join(', ')}.`;
                const system = `ä½ æ˜¯ä¸€ä¸ªå–„è§£äººæ„çš„æ—¥ç¨‹ç®¡å®¶ã€‚æ ¹æ®ç”¨æˆ·çš„èƒ½é‡å’Œå¿ƒæƒ…ï¼Œç»™å‡ºä»Šæ—¥å»ºè®®ã€‚
                å¦‚æœèƒ½é‡ä½ï¼Œå»ºè®®åªåšæœ€ç®€å•çš„1ä»¶äº‹ï¼Œéšè—å…¶ä»–çš„ã€‚
                å¦‚æœå¿ƒæƒ…å¥½ï¼Œé¼“åŠ±æŒ‘æˆ˜ä¸€ç‚¹éš¾çš„ã€‚
                è¯·ç”¨æ¸©æŸ”çš„ä¸­æ–‡ç®€çŸ­å›ç­”ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚`;
                
                const suggestion = await callGemini(prompt, system);
                if (suggestion) alert(suggestion); // ç®€åŒ–å¤„ç†ï¼Œå®é™…å¯ç”¨å¼¹çª—å±•ç¤º
                view.value = 'dashboard';
            };

            // --- åœºæ™¯ 2: Panic / Unstuck æ¨¡å¼ ---
            const startPanicMode = (initialTask = '') => {
                view.value = 'panic';
                panicMode.value = 'chat';
                chatHistory.value = [];
                currentSteps.value = [];
                
                // åˆå§‹å¼€åœºç™½
                const greeting = initialTask 
                    ? `æˆ‘çœ‹ä½ ç‚¹å‡»äº† "${initialTask}"ã€‚è§‰å¾—å“ªé‡Œéš¾ä»¥ä¸‹æ‰‹å—ï¼Ÿ`
                    : `å—¨ï¼Œçœ‹èµ·æ¥ä½ ç°åœ¨å¡ä½äº†ã€‚æˆ‘ä»¬è¦å»åšä»€ä¹ˆï¼Ÿæ˜¯æ´—æ¾¡ã€å†™è®ºæ–‡ï¼Œè¿˜æ˜¯ä¸çŸ¥é“åšä»€ä¹ˆï¼Ÿ`;
                
                chatHistory.value.push({ role: 'assistant', content: greeting });
                if (initialTask) userInput.value = `æˆ‘æƒ³åš ${initialTask}ï¼Œä½†æˆ‘ä¸æƒ³åŠ¨ã€‚`;
            };

            const sendMessage = async () => {
                if (!userInput.value.trim()) return;
                
                const text = userInput.value;
                chatHistory.value.push({ role: 'user', content: text });
                userInput.value = '';
                nextTick(() => {
                    const container = document.getElementById('chat-container');
                    if(container) container.scrollTop = container.scrollHeight;
                });

                // ç³»ç»Ÿæç¤ºè¯ï¼šCBT æ²»ç–—å¸ˆ + è°ˆåˆ¤ä¸“å®¶ + æ‹†è§£å¸ˆ
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„ CBT (è®¤çŸ¥è¡Œä¸ºç–—æ³•) æ²»ç–—å¸ˆå’Œæ‰§è¡ŒåŠŸèƒ½è¾…åŠ©æ•™ç»ƒã€‚
                ä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©æ‚£æœ‰æ‹–å»¶ç—‡æˆ–ç„¦è™‘çš„ç”¨æˆ·â€œåŠ¨èµ·æ¥â€ã€‚
                
                ç­–ç•¥ï¼š
                1. åŒç†å¿ƒï¼šå…ˆæ¥çº³ç”¨æˆ·çš„æƒ…ç»ªï¼ˆä¸æƒ³åŠ¨æ˜¯æ­£å¸¸çš„ï¼‰ã€‚
                2. è°ˆåˆ¤ï¼šå¦‚æœç”¨æˆ·æŠ—æ‹’ï¼Œæå‡ºâ€œåªåš 5 åˆ†é’Ÿâ€æˆ–â€œåªåšæœ€ç®€å•çš„ä¸€æ­¥â€ã€‚
                3. æ‹†è§£ï¼šå½“ç”¨æˆ·åŒæ„å°è¯•æ—¶ï¼Œå°†ä»»åŠ¡æ‹†è§£ä¸º JSON æ ¼å¼çš„å¾®æ­¥éª¤ã€‚
                
                å¦‚æœç”¨æˆ·æ˜ç¡®è¡¨ç¤ºæ„¿æ„å¼€å§‹æˆ–è¯¢é—®æ­¥éª¤ï¼Œè¯·æœ€åä»¥ JSON æ•°ç»„æ ¼å¼è¿”å›æ­¥éª¤ï¼Œä¸è¦ç”¨ markdown ä»£ç å—ï¼Œç›´æ¥æ”¾åœ¨æ–‡æœ¬æœ€åã€‚
                ä¾‹å¦‚ï¼š...å¥½çš„ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚["æ”¾ä¸‹æ‰‹æœº", "ç«™èµ·æ¥", "èµ°åˆ°é—¨å£"]
                
                å¦‚æœç”¨æˆ·è¿˜åœ¨æŠ—æ‹’ï¼Œç»§ç»­å¯¹è¯å¼•å¯¼ã€‚`;

                const reply = await callGemini(text, systemPrompt);
                
                if (reply) {
                    // æ£€æŸ¥æ˜¯å¦åŒ…å« JSON æ­¥éª¤
                    const jsonMatch = reply.match(/\[.*\]/s);
                    let content = reply;
                    
                    if (jsonMatch) {
                        try {
                            const steps = JSON.parse(jsonMatch[0]);
                            content = reply.replace(jsonMatch[0], '').trim(); // ç§»é™¤ JSON éƒ¨åˆ†æ˜¾ç¤ºæ–‡æœ¬
                            
                            chatHistory.value.push({ 
                                role: 'assistant', 
                                content: content,
                                actions: [{ label: 'å¼€å§‹æ‰§è¡Œ', type: 'start_steps', data: steps }]
                            });
                        } catch (e) {
                            chatHistory.value.push({ role: 'assistant', content: reply });
                        }
                    } else {
                        chatHistory.value.push({ role: 'assistant', content: reply });
                    }
                    
                    nextTick(() => {
                        const container = document.getElementById('chat-container');
                        if(container) container.scrollTop = container.scrollHeight;
                    });
                }
            };

            const handleAction = (action, msgIndex) => {
                chatHistory.value[msgIndex].actionTaken = true;
                if (action.type === 'start_steps') {
                    currentSteps.value = action.data;
                    currentStepIndex.value = 0;
                    panicMode.value = 'steps';
                }
            };

            const completeStep = () => {
                confetti({ particleCount: 150, spread: 60, origin: { y: 0.7 } });
                
                if (currentStepIndex.value < currentSteps.value.length - 1) {
                    setTimeout(() => currentStepIndex.value++, 800);
                } else {
                    setTimeout(() => {
                        alert("å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†å¯åŠ¨ã€‚ä¿æŒè¿™ä¸ªèŠ‚å¥ã€‚");
                        // å½’æ¡£ä»»åŠ¡ï¼ˆå¦‚æœæœ‰å¯¹åº”çš„è¯ï¼‰
                        if (focusTask.value) {
                            const t = tasks.value.find(t => t.id === focusTask.value.id);
                            if(t) { t.completed = true; t.completedAt = new Date().toISOString(); }
                            focusTask.value = null;
                        }
                        view.value = 'dashboard';
                    }, 1000);
                }
            };

            const negotiateStep = () => {
                // é‡æ–°å›åˆ°å¯¹è¯ï¼Œè®© AI æŠŠè¿™ä¸€æ­¥å†æ‹†ç»†
                panicMode.value = 'chat';
                const difficultStep = currentSteps.value[currentStepIndex.value];
                userInput.value = `æˆ‘è§‰å¾— "${difficultStep}" è¿™ä¸€æ­¥è¿˜æ˜¯å¤ªéš¾äº†ï¼Œèƒ½ä¸èƒ½å†ç®€å•ç‚¹ï¼Ÿ`;
                sendMessage();
            };

            return {
                view, apiKey, tempKey, selectedModel, customModelName, saveSettings,
                energyLevel, moodLevel, analyzeEnergy,
                tasks, activeTasks, archivedTasks, showAddTask, newTaskTitle, newTaskCategory, addTask, openAddTask, activateTask, focusTask,
                panicMode, chatHistory, userInput, isAiTyping, sendMessage, handleAction,
                currentSteps, currentStepIndex, stepProgress, completeStep, negotiateStep, startPanicMode,
                getCurrentGreeting, getMoodEmoji, formatTime, getBubbleStyle
            };
        }
    }).mount('#app');
</script>
</body>
</html>
